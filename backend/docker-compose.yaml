services:
  postgres:
    image: postgres:16-alpine
    container_name: uniflow-postgres
    environment:
      - TZ=Europe/Moscow
      - POSTGRES_DB=${PG_DATABASE_NAME:-auth}
      - POSTGRES_USER=${PG_USER:-postgres}
      - POSTGRES_PASSWORD=${PG_PASSWORD:-postgres}
    ports:
      - "${PG_EXTENDED_PORT:-50040}:5432"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_USER:-postgres} -d ${PG_DATABASE_NAME:-auth}"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - uniflow-network

  migrator:
    build:
      context: .
      dockerfile: docker/migrations/Dockerfile
      args:
        MIGRATIONS_DIR: ${MIGRATIONS_DIR:-migrations}
        TZ: Europe/Moscow
    container_name: uniflow-migrator
    environment:
      - PG_DSN=${PG_DSN:-host=postgres port=5432 dbname=auth user=postgres password=postgres sslmode=disable}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - uniflow-network
    restart: on-failure

  app:
    build:
      context: .
      dockerfile: docker/project/Dockerfile
      args:
        TZ: Europe/Moscow
    container_name: uniflow-app
    env_file:
      - docker/configs/config.env
    ports:
      - "${HTTP_PORT:-50031}:${HTTP_PORT:-50031}"
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost:${HTTP_PORT:-50031}/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - uniflow-network

networks:
  uniflow-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
