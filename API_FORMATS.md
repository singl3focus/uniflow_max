# Форматы API и структуры данных

Документация описывает форматы запросов и ответов API между фронтендом и бекэндом.

## Общие сведения

- Все ID в системе - это UUID (строки формата `"550e8400-e29b-41d4-a716-446655440000"`)
- Все даты и время в формате ISO 8601 (`"2025-11-15T10:30:00Z"`)
- Все поля в JSON используют snake_case (`user_id`, `created_at`, etc.)

## Формат ошибок

Все ошибки возвращаются в едином формате:

```json
{
  "error": "описание ошибки"
}
```

HTTP статусы ошибок:
- `400 Bad Request` - некорректные данные запроса
- `401 Unauthorized` - отсутствует или невалиден токен авторизации
- `404 Not Found` - ресурс не найден
- `500 Internal Server Error` - внутренняя ошибка сервера

## Аутентификация

### POST /api/auth/max

Вход через MAX ID.

**Запрос:**
```json
{
  "max_user_id": "string"
}
```

**Успешный ответ (200 OK):**
```json
{
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "max_user_id": "max_123456",
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

## Задачи (Tasks)

### GET /api/tasks

Получить все задачи текущего пользователя.

**Успешный ответ (200 OK):**
```json
{
  "tasks": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "user_id": "660e8400-e29b-41d4-a716-446655440001",
      "context_id": "770e8400-e29b-41d4-a716-446655440002",
      "title": "Подготовиться к экзамену",
      "description": "Повторить главы 1-5",
      "status": "todo",
      "due_at": "2025-11-20T18:00:00Z",
      "completed_at": null,
      "created_at": "2025-11-15T10:30:00Z",
      "updated_at": "2025-11-15T10:30:00Z"
    }
  ]
}
```

**Статусы задач:**
- `todo` - к выполнению
- `in_progress` - в процессе
- `completed` - завершена
- `cancelled` - отменена

### GET /api/tasks/today

Получить задачи на сегодня.

**Успешный ответ (200 OK):**
```json
{
  "tasks": [...]
}
```

### POST /api/tasks

Создать новую задачу.

**Запрос:**
```json
{
  "title": "Название задачи",
  "description": "Описание задачи",
  "context_id": "770e8400-e29b-41d4-a716-446655440002",
  "due_at": "2025-11-20T18:00:00Z"
}
```

Обязательные поля: `title`
Опциональные поля: `description`, `context_id`, `due_at`

**Успешный ответ (201 Created):**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "user_id": "660e8400-e29b-41d4-a716-446655440001",
  "context_id": "770e8400-e29b-41d4-a716-446655440002",
  "title": "Название задачи",
  "description": "Описание задачи",
  "status": "todo",
  "due_at": "2025-11-20T18:00:00Z",
  "completed_at": null,
  "created_at": "2025-11-15T10:30:00Z",
  "updated_at": "2025-11-15T10:30:00Z"
}
```

### GET /api/tasks/{id}

Получить задачу по ID.

**Успешный ответ (200 OK):**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "user_id": "660e8400-e29b-41d4-a716-446655440001",
  ...
}
```

### PATCH /api/tasks/{id}

Обновить задачу. Все поля опциональны.

**Запрос:**
```json
{
  "title": "Новое название",
  "description": "Новое описание",
  "context_id": "770e8400-e29b-41d4-a716-446655440002",
  "due_at": "2025-11-21T18:00:00Z"
}
```

**Успешный ответ (200 OK):**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  ...
}
```

### PATCH /api/tasks/{id}/status

Обновить статус задачи.

**Запрос:**
```json
{
  "status": "completed"
}
```

**Успешный ответ (200 OK):**
```json
{
  "status": "updated"
}
```

### DELETE /api/tasks/{id}

Удалить задачу.

**Успешный ответ (200 OK):**
```json
{
  "status": "deleted"
}
```

## Контексты (Contexts)

### GET /api/contexts

Получить все контексты текущего пользователя.

**Успешный ответ (200 OK):**
```json
{
  "contexts": [
    {
      "id": "770e8400-e29b-41d4-a716-446655440002",
      "user_id": "660e8400-e29b-41d4-a716-446655440001",
      "type": "subject",
      "title": "Математический анализ",
      "description": "Курс по матанализу",
      "subject_id": "math_101",
      "color": "#667eea",
      "deadline_at": "2025-12-20T23:59:59Z",
      "created_at": "2025-11-15T10:30:00Z",
      "updated_at": "2025-11-15T10:30:00Z"
    }
  ]
}
```

**Типы контекстов:**
- `subject` - учебный предмет
- `project` - проект
- `personal` - личное
- `work` - работа
- `other` - другое

### POST /api/contexts

Создать новый контекст.

**Запрос:**
```json
{
  "type": "subject",
  "title": "Математический анализ",
  "description": "Курс по матанализу",
  "subject_id": "math_101",
  "color": "#667eea",
  "deadline_at": "2025-12-20T23:59:59Z"
}
```

Обязательные поля: `type`, `title`, `color`
Опциональные поля: `description`, `subject_id`, `deadline_at`

**Успешный ответ (201 Created):**
```json
{
  "id": "770e8400-e29b-41d4-a716-446655440002",
  ...
}
```

### GET /api/contexts/{id}

Получить контекст по ID.

**Успешный ответ (200 OK):**
```json
{
  "id": "770e8400-e29b-41d4-a716-446655440002",
  ...
}
```

### PATCH /api/contexts/{id}

Обновить контекст. Все поля опциональны.

**Запрос:**
```json
{
  "type": "project",
  "title": "Новое название",
  "description": "Новое описание",
  "color": "#764ba2",
  "deadline_at": "2025-12-25T23:59:59Z"
}
```

**Успешный ответ (200 OK):**
```json
{
  "id": "770e8400-e29b-41d4-a716-446655440002",
  ...
}
```

### DELETE /api/contexts/{id}

Удалить контекст.

**Успешный ответ (200 OK):**
```json
{
  "status": "deleted"
}
```

## Поиск

### GET /api/search?q={query}

Поиск по задачам и контекстам.

**Параметры запроса:**
- `q` (обязательный) - поисковый запрос

**Успешный ответ (200 OK):**
```json
{
  "tasks": [...],
  "contexts": [...]
}
```

## Авторизация запросов

Все защищенные эндпоинты требуют JWT токен в заголовке:

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

Токен получается при успешной аутентификации через `/api/auth/max`.

## Примеры обработки ошибок

### Неавторизованный запрос (401)

```json
{
  "error": "unauthorized"
}
```

### Некорректные данные (400)

```json
{
  "error": "invalid request body"
}
```

### Ресурс не найден (404)

```json
{
  "error": "not found: task not found"
}
```

### Внутренняя ошибка (500)

```json
{
  "error": "internal server error: database connection failed"
}
```
